import os, json, time, logging, uuid, sqlite3, string, random, base64
from flask import Blueprint, render_template, jsonify, request, session, g, redirect, url_for
from functools import wraps
from azure.identity import ClientSecretCredential
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.network import NetworkManagementClient
from azure.mgmt.resource import ResourceManagementClient, SubscriptionClient
from azure.core.exceptions import ClientAuthenticationError, ResourceNotFoundError, HttpResponseError

# ã€æ ¸å¿ƒä¿®æ­£ã€‘ä»ä¸»ç¨‹åº app.py å¯¼å…¥å…±äº«çš„ Celery å®ä¾‹
from app import celery

# --- Blueprint Setup & Config ---
azure_bp = Blueprint('azure', __name__, template_folder='../templates', static_folder='../static')
KEYS_FILE = "azure_keys.json"
DATABASE = 'azure_tasks.db'

# --- æ•°æ®åº“è¾…åŠ©å‡½æ•° ---
def get_db_connection():
    """åˆ›å»ºä¸€ä¸ªæ–°çš„ã€é…ç½®å¥½çš„æ•°æ®åº“è¿æ¥"""
    db = sqlite3.connect(DATABASE, timeout=10)
    db.row_factory = sqlite3.Row
    return db

def get_db():
    """åœ¨ Flask è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨æˆ–åˆ›å»ºä¸€ä¸ªæ–°è¿æ¥"""
    db = getattr(g, '_azure_database', None)
    if db is None:
        db = g._azure_database = get_db_connection()
    return db

@azure_bp.teardown_request
def close_connection(exception):
    db = getattr(g, '_azure_database', None)
    if db is not None:
        db.close()

def init_db():
    """æ™ºèƒ½çš„æ•°æ®åº“åˆå§‹åŒ–å‡½æ•°ï¼Œæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨"""
    db = get_db_connection()
    cursor = db.cursor()
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='tasks'")
    table_exists = cursor.fetchone()
    if not table_exists:
        print("Initializing Azure database table 'tasks'...")
        logging.info("Azure DB file found, but 'tasks' table is missing. Creating table...")
        schema_sql = "CREATE TABLE tasks (id TEXT PRIMARY KEY, status TEXT NOT NULL, result TEXT);"
        cursor.executescript(schema_sql)
        db.commit()
        logging.info("'tasks' table created in Azure DB.")
    db.close()

def query_db(query, args=(), one=False):
    """ä¸€ä¸ªå®‰å…¨çš„ã€ä½¿ç”¨ç‹¬ç«‹è¿æ¥çš„æŸ¥è¯¢å‡½æ•°"""
    db = get_db_connection()
    cur = db.execute(query, args)
    rv = cur.fetchall()
    cur.close()
    db.close()
    return (rv[0] if rv else None) if one else rv

def _db_update_task(task_id, status, result):
    """ä¸€ä¸ªå®‰å…¨çš„ã€ç‹¬ç«‹çš„æ•°æ®åº“å†™å…¥å‡½æ•°ï¼Œä¸“ä¾›Celeryä»»åŠ¡ä½¿ç”¨"""
    db = None
    try:
        db = get_db_connection()
        db.execute('UPDATE tasks SET status = ?, result = ? WHERE id = ?', (status, result, task_id))
        db.commit()
    except Exception as e:
        logging.error(f"Error updating task {task_id} in DB: {e}")
    finally:
        if db:
            db.close()

# --- å…¶ä»–è¾…åŠ©å‡½æ•° ---
def load_keys():
    if not os.path.exists(KEYS_FILE): return []
    try:
        with open(KEYS_FILE, 'r') as f: content = f.read(); return json.loads(content) if content else []
    except json.JSONDecodeError: return []

def save_keys(keys):
    with open(KEYS_FILE, 'w') as f: json.dump(keys, f, indent=4)

def generate_password(length=12):
    characters = string.ascii_letters + string.digits + "!@#$%^&*()"
    return ''.join(random.choice(characters) for i in range(length))

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if "user_logged_in" not in session: return jsonify({"error": "ç”¨æˆ·æœªç™»å½•"}), 401
        return f(*args, **kwargs)
    return decorated_function

def azure_credentials_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'azure_credentials' not in session: return jsonify({"error": "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªAzureè´¦æˆ·"}), 403
        g.azure_creds = session['azure_credentials']
        return f(*args, **kwargs)
    return decorated_function

# --- Routes ---
@azure_bp.route("/")
@login_required
def azure_index():
    return render_template("azure.html")

@azure_bp.route("/api/accounts", methods=["GET", "POST"])
@login_required
def manage_accounts():
    if request.method == "GET": accounts = load_keys(); return jsonify(accounts)
    data = request.json; keys = load_keys()
    if any(k['name'] == data['name'] for k in keys): return jsonify({"error": "è´¦æˆ·åç§°å·²å­˜åœ¨"}), 400
    keys.append(data); save_keys(keys); return jsonify({"success": True}), 201

@azure_bp.route("/api/accounts/<name>", methods=["DELETE"])
@login_required
def delete_account(name):
    keys = load_keys(); keys_to_keep = [k for k in keys if k['name'] != name]
    if len(keys) == len(keys_to_keep): return jsonify({"error": "è´¦æˆ·æœªæ‰¾åˆ°"}), 404
    save_keys(keys_to_keep)
    if session.get('azure_credentials', {}).get('name') == name: session.pop('azure_credentials', None)
    return jsonify({"success": True})
    
@azure_bp.route('/api/accounts/edit', methods=['POST'])
@login_required
def edit_account():
    data = request.json; original_name, new_name, expiration_date = data.get('original_name'), data.get('new_name'), data.get('expiration_date')
    if not original_name or not new_name: return jsonify({"error": "è´¦æˆ·åç§°ä¸èƒ½ä¸ºç©º"}), 400
    keys = load_keys(); account_to_edit = next((k for k in keys if k['name'] == original_name), None)
    if not account_to_edit: return jsonify({"error": "æœªæ‰¾åˆ°åŸå§‹è´¦æˆ·"}), 404
    if new_name != original_name and any(k['name'] == new_name for k in keys): return jsonify({"error": "æ–°çš„è´¦æˆ·åç§°å·²å­˜åœ¨"}), 400
    account_to_edit['name'] = new_name; account_to_edit['expiration_date'] = expiration_date; save_keys(keys)
    if session.get('azure_credentials', {}).get('name') == original_name:
        session['azure_credentials']['name'] = new_name; session['azure_credentials']['expiration_date'] = expiration_date
    return jsonify({"success": True})
    
@azure_bp.route("/api/session", methods=["POST", "DELETE", "GET"])
@login_required
def azure_session():
    if request.method == "POST":
        name = request.json.get("name"); account = next((k for k in load_keys() if k['name'] == name), None)
        if not account: return jsonify({"error": "è´¦æˆ·æœªæ‰¾åˆ°"}), 404
        session['azure_credentials'] = account; return jsonify({"success": True, "name": account['name']})
    if request.method == "DELETE": session.pop('azure_credentials', None); return jsonify({"success": True})
    if 'azure_credentials' in session: return jsonify({"logged_in": True, "name": session['azure_credentials']['name']})
    return jsonify({"logged_in": False})

@azure_bp.route('/api/vms')
@login_required
@azure_credentials_required
def get_vms():
    try:
        credential = ClientSecretCredential(tenant_id=g.azure_creds['tenant_id'], client_id=g.azure_creds['client_id'], client_secret=g.azure_creds['client_secret'])
        subscription_id = g.azure_creds['subscription_id']
        compute_client, network_client = ComputeManagementClient(credential, subscription_id), NetworkManagementClient(credential, subscription_id)
        vm_list = []
        for vm in compute_client.virtual_machines.list_all():
            resource_group = vm.id.split('/')[4]
            try:
                instance_view = compute_client.virtual_machines.instance_view(resource_group, vm.name)
                status, public_ip = "Unknown", "N/A"
                power_state = next((s for s in instance_view.statuses if s.code.startswith('PowerState/')), None)
                if power_state: status = power_state.display_status.replace("VM ", "")
            except ResourceNotFoundError:
                status = "Not Found"

            try:
                if vm.network_profile and vm.network_profile.network_interfaces:
                    nic_id = vm.network_profile.network_interfaces[0].id; nic_name = nic_id.split('/')[-1]
                    nic = network_client.network_interfaces.get(resource_group, nic_name)
                    if nic.ip_configurations and nic.ip_configurations[0].public_ip_address:
                        pip_id = nic.ip_configurations[0].public_ip_address.id; pip_name = pip_id.split('/')[-1]
                        pip = network_client.public_ip_addresses.get(resource_group, pip_name); public_ip = pip.ip_address
            except Exception: public_ip = "æŸ¥è¯¢å¤±è´¥"
            vm_list.append({"name": vm.name, "location": vm.location, "vm_size": vm.hardware_profile.vm_size, "status": status, "resource_group": resource_group, "public_ip": public_ip, "time_created": vm.time_created.isoformat() if vm.time_created else None})
        return jsonify(vm_list)
    except Exception as e: return jsonify({"error": str(e)}), 500

@azure_bp.route('/api/regions')
@login_required
@azure_credentials_required
def get_regions():
    try:
        credential = ClientSecretCredential(tenant_id=g.azure_creds['tenant_id'], client_id=g.azure_creds['client_id'], client_secret=g.azure_creds['client_secret'])
        subscription_client = SubscriptionClient(credential)
        locations = subscription_client.subscriptions.list_locations(g.azure_creds['subscription_id'])
        region_list = [{"name": loc.name, "display_name": loc.display_name} for loc in locations]
        return jsonify(region_list)
    except Exception as e: return jsonify({"error": f"è·å–åŒºåŸŸåˆ—è¡¨å¤±è´¥: {str(e)}"}), 500

@azure_bp.route('/api/vm-action', methods=['POST'])
@login_required
@azure_credentials_required
def vm_action():
    data = request.json
    action = data.get('action')
    vm_name = data.get('vm_name')
    
    task_id = str(uuid.uuid4())
    db = get_db()
    db.execute('INSERT INTO tasks (id, status, result) VALUES (?, ?, ?)', (task_id, 'pending', f"ä»»åŠ¡å·²æäº¤: {action} on {vm_name}"))
    db.commit()

    # ã€æ ¸å¿ƒä¿®æ­£ã€‘è°ƒç”¨ Celery ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ threading
    _vm_action_task.delay(
        task_id=task_id,
        credential_dict={k: g.azure_creds[k] for k in ['tenant_id', 'client_id', 'client_secret']},
        subscription_id=g.azure_creds['subscription_id'],
        action=action,
        resource_group=data.get('resource_group'),
        vm_name=vm_name
    )
    
    return jsonify({"message": f"æ“ä½œå·²æäº¤ï¼Œå°†åœ¨åå°æ‰§è¡Œ...", "task_id": task_id})

@azure_bp.route('/api/vm-change-ip', methods=['POST'])
@login_required
@azure_credentials_required
def change_vm_ip():
    data = request.json
    vm_name = data.get('vm_name')

    task_id = str(uuid.uuid4())
    db = get_db()
    db.execute('INSERT INTO tasks (id, status, result) VALUES (?, ?, ?)', (task_id, 'pending', f"ä»»åŠ¡å·²æäº¤: change IP on {vm_name}"))
    db.commit()

    # ã€æ ¸å¿ƒä¿®æ­£ã€‘è°ƒç”¨ Celery ä»»åŠ¡
    _change_ip_task.delay(
        task_id=task_id,
        credential_dict={k: g.azure_creds[k] for k in ['tenant_id', 'client_id', 'client_secret']},
        subscription_id=g.azure_creds['subscription_id'],
        rg_name=data.get('resource_group'),
        vm_name=vm_name
    )
    return jsonify({"message": f"æ­£åœ¨ä¸ºè™šæ‹Ÿæœº {vm_name} ç”³è¯·æ–°çš„IPåœ°å€...", "task_id": task_id})

@azure_bp.route('/api/create-vm', methods=['POST'])
@login_required
@azure_credentials_required
def create_vm():
    task_id = str(uuid.uuid4())
    db = get_db()
    db.execute('INSERT INTO tasks (id, status, result) VALUES (?, ?, ?)', (task_id, 'pending', 'ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—...'))
    db.commit()
    data = request.json

    # ã€æ ¸å¿ƒä¿®æ­£ã€‘è°ƒç”¨ Celery ä»»åŠ¡
    _create_vm_task.delay(
        task_id=task_id,
        credential_dict={k: g.azure_creds[k] for k in ['tenant_id', 'client_id', 'client_secret']},
        subscription_id=g.azure_creds['subscription_id'],
        vm_name=f"vm-{data.get('region').replace(' ','').lower()}-{int(time.time())}",
        rg_name=f"rg-{data.get('region').replace(' ','').lower()}-{int(time.time())}", 
        admin_password=generate_password(),
        data=data
    )
    return jsonify({ "message": f"åˆ›å»ºè¯·æ±‚å·²æäº¤...", "task_id": task_id })

@azure_bp.route('/api/task_status/<task_id>')
@login_required
def task_status(task_id):
    task = query_db('SELECT * FROM tasks WHERE id = ?', [task_id], one=True)
    if task is None: return jsonify({'status': 'not_found'}), 404
    return jsonify({'status': task['status'], 'result': task['result']})
    
# --- Celery Tasks (åŸ threading å‡½æ•°å·²æ”¹é€ ä¸º Celery ä»»åŠ¡) ---

@celery.task
def _vm_action_task(task_id, credential_dict, subscription_id, action, resource_group, vm_name):
    _db_update_task(task_id, 'running', f'æ­£åœ¨å¯¹ {vm_name} æ‰§è¡Œ {action} æ“ä½œ...')
    try:
        credential = ClientSecretCredential(**credential_dict)
        compute_client = ComputeManagementClient(credential, subscription_id)
        
        if action == 'start': 
            poller = compute_client.virtual_machines.begin_start(resource_group, vm_name)
            result_message = f"âœ… è™šæ‹Ÿæœº {vm_name} å¯åŠ¨æˆåŠŸï¼"
        elif action == 'stop': 
            poller = compute_client.virtual_machines.begin_deallocate(resource_group, vm_name)
            result_message = f"âœ… è™šæ‹Ÿæœº {vm_name} åœæ­¢æˆåŠŸï¼"
        elif action == 'restart': 
            poller = compute_client.virtual_machines.begin_restart(resource_group, vm_name)
            result_message = f"âœ… è™šæ‹Ÿæœº {vm_name} é‡å¯æˆåŠŸï¼"
        elif action == 'delete':
            resource_client = ResourceManagementClient(credential, subscription_id)
            poller = resource_client.resource_groups.begin_delete(resource_group)
            result_message = f"âœ… èµ„æºç»„ {resource_group} åŠå†…éƒ¨èµ„æºåˆ é™¤æˆåŠŸï¼"
        else: 
            raise ValueError("æœªçŸ¥çš„æ“ä½œ")
        
        poller.result()
        _db_update_task(task_id, 'success', result_message)
    except Exception as e:
        error_message = f"âŒ å¯¹ {vm_name} æ‰§è¡Œ {action} å¤±è´¥: {str(e)}"
        _db_update_task(task_id, 'failure', error_message)
        logging.error(f"Azureåå°ä»»åŠ¡ '{action}' å¤±è´¥: {e}")

@celery.task
def _change_ip_task(task_id, credential_dict, subscription_id, rg_name, vm_name):
    _db_update_task(task_id, 'running', f'æ­£åœ¨ä¸º {vm_name} æ›´æ¢IP...')
    try:
        credential = ClientSecretCredential(**credential_dict)
        compute_client = ComputeManagementClient(credential, subscription_id)
        network_client = NetworkManagementClient(credential, subscription_id)
        vm = compute_client.virtual_machines.get(rg_name, vm_name)
        nic = network_client.network_interfaces.get(rg_name, vm.network_profile.network_interfaces[0].id.split('/')[-1])
        ip_config = nic.ip_configurations[0]
        old_pip_id = ip_config.public_ip_address.id if ip_config.public_ip_address else None
        
        if old_pip_id:
            old_pip_name = old_pip_id.split('/')[-1]
            _db_update_task(task_id, 'running', 'æ­£åœ¨è§£ç»‘æ—§IP...')
            ip_config.public_ip_address = None
            network_client.network_interfaces.begin_create_or_update(rg_name, nic.name, nic).result()
            _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ é™¤æ—§IP...')
            network_client.public_ip_addresses.begin_delete(rg_name, old_pip_name).result()

        new_pip_name = f"pip-{vm_name}-{int(time.time())}"
        pip_params = {"location": vm.location, "sku": {"name": "Standard"}, "public_ip_allocation_method": "Static"}
        _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ›å»ºæ–°IP...')
        new_pip = network_client.public_ip_addresses.begin_create_or_update(rg_name, new_pip_name, pip_params).result()
        
        _db_update_task(task_id, 'running', 'æ­£åœ¨ç»‘å®šæ–°IP...')
        ip_config.public_ip_address = new_pip
        network_client.network_interfaces.begin_create_or_update(rg_name, nic.name, nic).result()
        
        _db_update_task(task_id, 'running', 'æ­£åœ¨æ£€æŸ¥ç½‘ç»œå®‰å…¨ç»„(NSG)...')
        if nic.network_security_group:
            nsg_name = nic.network_security_group.id.split('/')[-1]
            nsg = network_client.network_security_groups.get(rg_name, nsg_name)
            ssh_rule_exists = any(r.destination_port_range == '22' for r in nsg.security_rules if r.direction.lower() == 'inbound' and r.access.lower() == 'allow')
            if not ssh_rule_exists:
                _db_update_task(task_id, 'running', 'æœªæ‰¾åˆ°SSHè§„åˆ™ï¼Œæ­£åœ¨åˆ›å»º...')
                highest_priority = max([r.priority for r in nsg.security_rules] + [999])
                rule_params = {'name': 'AllowSSH_Auto_Panel', 'protocol': 'Tcp','source_address_prefix': 'Internet', 'source_port_range': '*','destination_address_prefix': '*', 'destination_port_range': '22','access': 'Allow', 'direction': 'Inbound', 'priority': highest_priority + 10}
                nsg.security_rules.append(rule_params)
                network_client.network_security_groups.begin_create_or_update(rg_name, nsg_name, nsg).result()
                _db_update_task(task_id, 'running', 'SSHè§„åˆ™åˆ›å»ºæˆåŠŸï¼')
        
        result_message = f"âœ… IPæ›´æ¢æˆåŠŸï¼\n- è™šæ‹Ÿæœº: {vm_name}\n- æ–°IPåœ°å€: {new_pip.ip_address}\n- SSH(22)ç«¯å£å·²ç¡®ä¿å¼€æ”¾ã€‚"
        _db_update_task(task_id, 'success', result_message)
    except Exception as e:
        error_message = f"âŒ æ›´æ¢IPå¤±è´¥ for {vm_name}: {str(e)}"
        _db_update_task(task_id, 'failure', error_message)
        logging.error(error_message)

@celery.task
def _create_vm_task(task_id, credential_dict, subscription_id, vm_name, rg_name, admin_password, data):
    _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ›å»ºèµ„æºç»„...')
    try:
        credential = ClientSecretCredential(**credential_dict)
        compute_client = ComputeManagementClient(credential, subscription_id)
        network_client = NetworkManagementClient(credential, subscription_id)
        resource_client = ResourceManagementClient(credential, subscription_id)

        location = data.get('region')
        ip_type = data.get('ip_type')
        os_images = {
            "debian12": {"publisher": "Debian", "offer": "debian-12", "sku": "12-gen2", "version": "latest"},
            "debian11": {"publisher": "Debian", "offer": "debian-11", "sku": "11-gen2", "version": "latest"},
            "ubuntu22": {"publisher": "Canonical", "offer": "0001-com-ubuntu-server-jammy", "sku": "22_04-lts-gen2", "version": "latest"},
            "ubuntu20": {"publisher": "Canonical", "offer": "0001-com-ubuntu-server-focal", "sku": "20_04-lts-gen2", "version": "latest"},
        }
        image_reference = os_images.get(data.get('os_image'))
        admin_username = "azureuser"

        resource_client.resource_groups.create_or_update(rg_name, {"location": location})
        
        _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ›å»ºè™šæ‹Ÿç½‘ç»œ...')
        vnet_poller = network_client.virtual_networks.begin_create_or_update(rg_name, f"vnet-{vm_name}", {"location": location, "address_space": {"address_prefixes": ["10.0.0.0/16"]}, "subnets": [{"name": "default", "address_prefix": "10.0.0.0/24"}]})
        subnet_id = vnet_poller.result().subnets[0].id

        _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ›å»ºå…¬ç½‘IP...')
        ip_sku = {"name": "Basic"} if ip_type == "Dynamic" else {"name": "Standard"}
        pip_poller = network_client.public_ip_addresses.begin_create_or_update(rg_name, f"pip-{vm_name}", {"location": location, "sku": ip_sku, "public_ip_allocation_method": ip_type})
        public_ip_id = pip_poller.result().id
        
        nsg_name = f"nsg-{vm_name}"
        _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ›å»ºå¹¶é…ç½®ç½‘ç»œå®‰å…¨ç»„(NSG)...')
        nsg_params = {'location': location, 'security_rules': [{'name': 'AllowSSH_Default','protocol': 'Tcp','source_address_prefix': 'Internet','source_port_range': '*','destination_address_prefix': '*','destination_port_range': '22','access': 'Allow','direction': 'Inbound','priority': 1000}, {'name': 'AllowAll_Inbound_DANGEROUS','protocol': '*','source_address_prefix': '*','source_port_range': '*','destination_address_prefix': '*','destination_port_range': '*','access': 'Allow','direction': 'Inbound','priority': 1010}, {'name': 'AllowAll_Outbound','protocol': '*','source_address_prefix': '*','source_port_range': '*','destination_address_prefix': '*','destination_port_range': '*','access': 'Allow','direction': 'Outbound','priority': 1000}]}
        nsg_poller = network_client.network_security_groups.begin_create_or_update(rg_name, nsg_name, nsg_params)
        nsg_id = nsg_poller.result().id
        
        _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ›å»ºç½‘ç»œæ¥å£å¹¶å…³è”NSG...')
        nic_poller = network_client.network_interfaces.begin_create_or_update(rg_name, f"nic-{vm_name}", {"location": location, "ip_configurations": [{"name": "ipconfig1", "subnet": {"id": subnet_id}, "public_ip_address": {"id": public_ip_id}}], "network_security_group": {"id": nsg_id}})
        nic_id = nic_poller.result().id
        
        azure_params = {"location": location, "storage_profile": {"image_reference": image_reference, "os_disk": {"create_option": "FromImage", "disk_size_gb": data.get('disk_size')}}, "hardware_profile": {"vm_size": data.get('vm_size')}, "os_profile": {"computer_name": vm_name, "admin_username": admin_username, "admin_password": admin_password}, "network_profile": {"network_interfaces": [{"id": nic_id}]}}
        
        user_data_b64 = data.get('user_data')
        if user_data_b64:
            azure_params["os_profile"]["custom_data"] = user_data_b64
        
        _db_update_task(task_id, 'running', 'æ­£åœ¨åˆ›å»ºè™šæ‹Ÿæœºï¼Œæ­¤è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ...')
        vm_poller = compute_client.virtual_machines.begin_create_or_update(rg_name, vm_name, azure_params)
        vm_poller.result()

        final_pip = network_client.public_ip_addresses.get(rg_name, f"pip-{vm_name}")
        success_message = f"ğŸ‰ è™šæ‹Ÿæœº {vm_name} åˆ›å»ºæˆåŠŸ! \n- å…¬ç½‘ IP: {final_pip.ip_address}\n- ç”¨æˆ·å: {admin_username}\n- å¯†  ç : {admin_password}\n- æ‰€æœ‰ç½‘ç»œç«¯å£å·²è‡ªåŠ¨å¼€æ”¾"
        _db_update_task(task_id, 'success', success_message)
        logging.info(f"åå°ä»»åŠ¡({task_id})æˆåŠŸ")
    except Exception as e:
        user_friendly_reason = str(e)
        if isinstance(e, HttpResponseError) and hasattr(e, 'error') and e.error and hasattr(e.error, 'code') and e.error.code == "RequestDisallowedByPolicy":
            user_friendly_reason = "è´¦å·ä¸æ”¯æŒåœ¨è¯¥åŒºåŸŸåˆ›å»ºå®ä¾‹æˆ–æ‰€é€‰é…ç½®"
        
        error_message = f"âŒ è™šæ‹Ÿæœº {rg_name} åˆ›å»ºå¤±è´¥! \n    - åŸå› : {user_friendly_reason}"
        _db_update_task(task_id, 'failure', error_message)
        logging.error(f"åå°ä»»åŠ¡({task_id})å¤±è´¥: {str(e)}")
        try:
            resource_client = ResourceManagementClient(ClientSecretCredential(**credential_dict), subscription_id)
            resource_client.resource_groups.begin_delete(rg_name).wait()
            logging.info(f"å·²æ¸…ç†å¤±è´¥ä»»åŠ¡çš„èµ„æºç»„: {rg_name}")
        except Exception as cleanup_e:
             logging.error(f"æ¸…ç†èµ„æºç»„ {rg_name} å¤±è´¥: {cleanup_e}")
